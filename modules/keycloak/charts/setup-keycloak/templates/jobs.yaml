---
apiVersion: batch/v1
kind: Job
metadata:
  name: setup-data-keycloak
  labels:
    app: setup-data-keycloak
    sourceapp: setup-sample-keycloak
    sourceversion: 1.0.0
    sourceappversion: 1.0.0
spec:
  backoffLimit: {{ .Values.setup_data_keycloak.backoffLimit }}
  template:
    metadata:
      labels:
        app: setup-data-keycloak
        sidecar.istio.io/inject: "false"
    spec:
      {{- if .Values.serviceAccount.create }}
      serviceAccountName: setup-data-keycloak
      {{- end }}
      restartPolicy: Never
      volumes:
        - name: setup-script
          configMap:
            name: cmd-script
      containers:
      - name: setup-data-keycloak
        image: {{ .Values.setup_data_keycloak.image.repository }}:{{ .Values.setup_data_keycloak.image.tag }}
        imagePullPolicy: {{ .Values.pullPolicy }}
        volumeMounts:
        - name: setup-script
          mountPath: /app/src/cmd.js
          subPath: cmd.js
        env:
        - name: KEYCLOAK_SVC
          value: "md-keycloak.md-security"
        - name: KEYCLOAK_PORT
          value: "443"
        - name: KEYCLOAK_ADMIN_USR
          value: "user"
        - name: KEYCLOAK_ADMIN_PWD
          value: "mioKarofa91Mia"
        securityContext:
          runAsUser: 1000
        {{ if .Values.setup_data_keycloak.resources }}
        resources: {{- toYaml .Values.setup_data_keycloak.resources | nindent 8 }}
        {{ end }}
